(function(e){var t;define([],function(){return function(){describe("Components: Loader registry",function(){function c(e,t){var n,r=!1;runs(function(){ko.components.get(e,function(e){n=e,r=!0}),expect(r).toBe(!1)}),waitsFor(function(){return r}),runs(function(){t(n)})}var e=20,t="test-component",n={},r={template:{}},i={getConfig:function(n,r){expect(n).toBe(t),setTimeout(function(){r(null)},e)},loadComponent:function(r,i,s){expect(r).toBe(t),expect(i).toBe(n),setTimeout(function(){s(null)},e)}},s={},o={getConfig:function(r,i){expect(r).toBe(t),setTimeout(function(){i(n)},e)}},u={loadComponent:function(i,s,o){expect(i).toBe(t),expect(s).toBe(n),setTimeout(function(){o(r)},e)}},a={getConfig:function(){throw new Error("Should not be called")},loadComponent:function(){throw new Error("Should not be called")}},f={getConfig:function(e,t){t(n)},loadComponent:function(e,t,i){expect(t).toBe(n),i(r)}},l=function(e,n,r){e.restoreAfter(ko.components,"loaders"),ko.components.loaders=n;var i="Not yet loaded";ko.components.get(t,function(e){i=e});var s=function(){"expectedDefinition"in r&&expect(i).toBe(r.expectedDefinition),"done"in r&&r.done(i)};i!=="Not yet loaded"?s():(waitsFor(function(){return i!=="Not yet loaded"},300),runs(s))};afterEach(function(){ko.components.unregister(t)}),it("Exposes the list of loaders as an array",function(){expect(ko.components.loaders instanceof Array).toBe(!0)}),it("Obtains component config and component definition objects by invoking each loader in turn, asynchronously, until one supplies a value",function(){var e=[i,s,u,i,o,a];l(this,e,{expectedDefinition:r})}),it("Supplies null if no registered loader returns a config object",function(){var e=[i,s,u,i];l(this,e,{expectedDefinition:null})}),it("Supplies null if no registered loader returns a component for a given config object",function(){var e=[i,s,o,i];l(this,e,{expectedDefinition:null})}),it("Aborts if a getConfig call returns a value other than undefined",function(){var e=[u,i,{getConfig:function(e,t){return setTimeout(function(){t(r)},50),r},suppressLoaderExceptions:!0},o];l(this,e,{expectedDefinition:null})}),it("Aborts if a loadComponent call returns a value other than undefined",function(){var e=[o,i,{loadComponent:function(e,t,n){return setTimeout(function(){n(r)},50),r},suppressLoaderExceptions:!0},u];l(this,e,{expectedDefinition:null})}),it("Ensures that the loading process completes asynchronously, even if the loader completed synchronously",function(){var e=!1;l(this,[f],{expectedDefinition:r,done:function(){expect(e).toBe(!0)}}),e=!0}),it('Supplies component definition synchronously if the "synchronous" flag is provided and the loader completes synchronously',function(){this.restoreAfter(ko.components,"loaders");var e={synchronous:!0},t={},n="my-sync-component",r=0;ko.components.loaders=[{getConfig:function(t,n){r++,n(e)},loadComponent:function(n,r,i){expect(r).toBe(e),i(t)}}];var i=!1;ko.components.get(n,function(e){expect(e).toBe(t),i=!0}),expect(i).toBe(!0),expect(r).toBe(1);var s=!1;ko.components.get(n,function(e){expect(e).toBe(t),s=!0}),expect(s).toBe(!0),expect(r).toBe(1);var o=ko.observable("Initial"),u=0;ko.computed(function(){ko.components.get(n,function(e){u++,o()})}),expect(u).toBe(1),o("Modified"),expect(u).toBe(1)}),it('Supplies component definition synchronously if the "synchronous" flag is provided and definition is already cached',function(){this.restoreAfter(ko.components,"loaders"),this.after(function(){delete n.synchronous}),n.synchronous="trueish value",ko.components.loaders=[o,u];var e=!1;c(t,function(n){expect(e).toBe(!0),expect(n).toBe(r);var i=!1;ko.components.get(t,function(e){i=!0,expect(e).toBe(r)}),expect(i).toBe(!0)}),e=!0}),it("By default, contains only the default loader",function(){expect(ko.components.loaders.length).toBe(1),expect(ko.components.loaders[0]).toBe(ko.components.defaultLoader)}),it("Caches and reuses loaded component definitions",function(){this.after(function(){ko.components.unregister("some-component"),ko.components.unregister("other-component")}),ko.components.register("some-component",{viewModel:function(){this.isTheTestComponent=!0}}),ko.components.register("other-component",{viewModel:function(){this.isTheOtherComponent=!0}});var e;c("some-component",function(t){e=t,expect(e.createViewModel().isTheTestComponent).toBe(!0)}),c("some-component",function(t){expect(t).toBe(e)}),c("other-component",function(t){expect(t).not.toBe(e),expect(t.createViewModel().isTheOtherComponent).toBe(!0)}),runs(function(){ko.components.clearCachedDefinition("some-component")}),c("some-component",function(t){expect(t).not.toBe(e),expect(t.createViewModel().isTheTestComponent).toBe(!0)}),runs(function(){ko.components.unregister("some-component")}),c("some-component",function(e){expect(e).toBe(null)})}),it("Only commences a single loading process, even if multiple requests arrive before loading has completed",function(){var e=[],n={template:e},r=[];this.restoreAfter(window,"require"),window.require=function(e,t){r.push(e.slice(0)),setTimeout(function(){t(n)},80)},ko.components.register(t,{require:"path/testcomponent"});var i=undefined;ko.components.get(t,function(e){i=e}),expect(r).toEqual([["path/testcomponent"]]);var s=undefined;waits(20),runs(function(){expect(i).toBe(undefined),ko.components.get(t,function(e){s=e}),expect(r.length).toBe(1)}),waitsFor(function(){return i},300),runs(function(){expect(i.template).toBe(e),expect(s).toBe(i)}),c(t,function(e){expect(e).toBe(i),expect(r.length).toBe(1)})})})}.call(e),t})})(this);