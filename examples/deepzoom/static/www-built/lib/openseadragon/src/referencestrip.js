/*
 * OpenSeadragon - ReferenceStrip
 *
 * Copyright (C) 2009 CodePlex Foundation
 * Copyright (C) 2010-2013 OpenSeadragon contributors
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * - Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 *
 * - Redistributions in binary form must reproduce the above copyright
 *   notice, this list of conditions and the following disclaimer in the
 *   documentation and/or other materials provided with the distribution.
 *
 * - Neither the name of CodePlex Foundation nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(e){var t;define([],function(){return function(){(function(e){function n(t){var n=Number(this.element.style.marginLeft.replace("px","")),r=Number(this.element.style.marginTop.replace("px","")),s=Number(this.element.style.width.replace("px","")),o=Number(this.element.style.height.replace("px","")),u=e.getElementSize(this.viewer.canvas);return this.dragging=!0,this.element&&("horizontal"==this.scroll?-t.delta.x>0?n>-(s-u.x)&&(this.element.style.marginLeft=n+t.delta.x*2+"px",i(this,u.x,n+t.delta.x*2)):-t.delta.x<0&&n<0&&(this.element.style.marginLeft=n+t.delta.x*2+"px",i(this,u.x,n+t.delta.x*2)):-t.delta.y>0?r>-(o-u.y)&&(this.element.style.marginTop=r+t.delta.y*2+"px",i(this,u.y,r+t.delta.y*2)):-t.delta.y<0&&r<0&&(this.element.style.marginTop=r+t.delta.y*2+"px",i(this,u.y,r+t.delta.y*2))),!1}function r(t){var n=Number(this.element.style.marginLeft.replace("px","")),r=Number(this.element.style.marginTop.replace("px","")),s=Number(this.element.style.width.replace("px","")),o=Number(this.element.style.height.replace("px","")),u=e.getElementSize(this.viewer.canvas);return this.element&&("horizontal"==this.scroll?t.scroll>0?n>-(s-u.x)&&(this.element.style.marginLeft=n-t.scroll*60+"px",i(this,u.x,n-t.scroll*60)):t.scroll<0&&n<0&&(this.element.style.marginLeft=n-t.scroll*60+"px",i(this,u.x,n-t.scroll*60)):t.scroll<0?r>u.y-o&&(this.element.style.marginTop=r+t.scroll*60+"px",i(this,u.y,r+t.scroll*60)):t.scroll>0&&r<0&&(this.element.style.marginTop=r+t.scroll*60+"px",i(this,u.y,r+t.scroll*60))),!1}function i(t,n,r){var i,s,o,u,a,f,l;"horizontal"==t.scroll?i=t.panelWidth:i=t.panelHeight,s=Math.ceil(n/i)+5,o=Math.ceil((Math.abs(r)+n)/i)+1,s=o-s,s=s<0?0:s;for(f=s;f<o&&f<t.panels.length;f++)l=t.panels[f],l.activePanel||(u=new e.Viewer({id:l.id,tileSources:[t.viewer.tileSources[f]],element:l,navigatorSizeRatio:t.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0}),u.displayRegion=e.makeNeutralElement("textarea"),u.displayRegion.id=l.id+"-displayregion",u.displayRegion.className="displayregion",a=u.displayRegion.style,a.position="relative",a.top="0px",a.left="0px",a.fontSize="0px",a.overflow="hidden",a.float="left",a.cssFloat="left",a.styleFloat="left",a.zIndex=999999999,a.cursor="default",a.width=t.panelWidth-4+"px",a.height=t.panelHeight-4+"px",u.displayRegion.innerTracker=new e.MouseTracker({element:u.displayRegion,startDisabled:!0}),l.getElementsByTagName("div")[0].appendChild(u.displayRegion),l.activePanel=!0)}function s(e){var t=e.eventSource.element;return"horizontal"==this.scroll?t.style.marginBottom="0px":t.style.marginLeft="0px",!1}function o(t){var n=t.eventSource.element;return"horizontal"==this.scroll?n.style.marginBottom="-"+e.getElementSize(n).y/2+"px":n.style.marginLeft="-"+e.getElementSize(n).x/2+"px",!1}function u(e){if(!(!e.preventDefaultAction&&!e.ctrl&&!e.alt&&!e.meta))return!0;switch(e.keyCode){case 38:return r.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 40:return r.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 37:return r.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 39:return r.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;default:return!0}}function a(e){if(!(!e.preventDefaultAction&&!e.ctrl&&!e.alt&&!e.meta))return!0;switch(e.keyCode){case 61:return r.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 45:return r.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 48:case 119:case 87:return r.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 115:case 83:return r.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 97:return r.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;case 100:return r.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;default:return!0}}var t={};e.ReferenceStrip=function(f){var l=this,c=f.viewer,h=e.getElementSize(c.element),p,d,v;f.id||(f.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=f.id,this.element.className="referencestrip"),f=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},f,{element:this.element,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1}),e.extend(this,f),t[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,d=this.element.style,d.marginTop="0px",d.marginRight="0px",d.marginBottom="0px",d.marginLeft="0px",d.left="0px",d.bottom="0px",d.border="0px",d.background="#000",d.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=c,this.innerTracker=new e.MouseTracker({element:this.element,dragHandler:e.delegate(this,n),scrollHandler:e.delegate(this,r),enterHandler:e.delegate(this,s),exitHandler:e.delegate(this,o),keyDownHandler:e.delegate(this,u),keyHandler:e.delegate(this,a)}),f.width&&f.height?(this.element.style.width=f.width+"px",this.element.style.height=f.height+"px",c.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):"horizontal"==f.scroll?(this.element.style.width=h.x*f.sizeRatio*c.tileSources.length+12*c.tileSources.length+"px",this.element.style.height=h.y*f.sizeRatio+"px",c.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=h.y*f.sizeRatio*c.tileSources.length+12*c.tileSources.length+"px",this.element.style.width=h.x*f.sizeRatio+"px",c.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=h.x*this.sizeRatio+8,this.panelHeight=h.y*this.sizeRatio+8,this.panels=[];for(v=0;v<c.tileSources.length;v++)p=e.makeNeutralElement("div"),p.id=this.element.id+"-"+v,p.style.width=l.panelWidth+"px",p.style.height=l.panelHeight+"px",p.style.display="inline",p.style.float="left",p.style.cssFloat="left",p.style.styleFloat="left",p.style.padding="2px",e.setElementTouchActionNone(p),p.innerTracker=new e.MouseTracker({element:p,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,pressHandler:function(t){t.eventSource.dragging=e.now()},releaseHandler:function(t){var n=t.eventSource,r=n.element.id,i=Number(r.split("-")[2]),s=e.now();t.insideElementPressed&&t.insideElementReleased&&n.dragging&&s-n.dragging<n.clickTimeThreshold&&(n.dragging=null,c.goToPage(i))}}),this.element.appendChild(p),p.activePanel=!1,this.panels.push(p);i(this,this.scroll=="vertical"?h.y:h.y,0),this.setFocus(0)},e.extend(e.ReferenceStrip.prototype,e.EventSource.prototype,e.Viewer.prototype,{setFocus:function(t){var n=e.getElement(this.element.id+"-"+t),r=e.getElementSize(this.viewer.canvas),o=Number(this.element.style.width.replace("px","")),u=Number(this.element.style.height.replace("px","")),a=-Number(this.element.style.marginLeft.replace("px","")),f=-Number(this.element.style.marginTop.replace("px","")),l;this.currentSelected!==n&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=n,this.currentSelected.style.background="#999","horizontal"==this.scroll?(l=Number(t)*(this.panelWidth+3),l>a+r.x-this.panelWidth?(l=Math.min(l,o-r.x),this.element.style.marginLeft=-l+"px",i(this,r.x,-l)):l<a&&(l=Math.max(0,l-r.x/2),this.element.style.marginLeft=-l+"px",i(this,r.x,-l))):(l=Number(t)*(this.panelHeight+3),l>f+r.y-this.panelHeight?(l=Math.min(l,u-r.y),this.element.style.marginTop=-l+"px",i(this,r.y,-l)):l<f&&(l=Math.max(0,l-r.y/2),this.element.style.marginTop=-l+"px",i(this,r.y,-l))),this.currentPage=t,e.getElement(n.id+"-displayregion").focus(),s.call(this,{eventSource:this.innerTracker}))},update:function(){return t[this.id].animating?(e.console.log("image reference strip update"),!0):!1}})})(OpenSeadragon)}.call(e),t})})(this);