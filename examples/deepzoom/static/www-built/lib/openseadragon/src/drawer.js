/*
 * OpenSeadragon - Drawer
 *
 * Copyright (C) 2009 CodePlex Foundation
 * Copyright (C) 2010-2013 OpenSeadragon contributors
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * - Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 *
 * - Redistributions in binary form must reproduce the above copyright
 *   notice, this list of conditions and the following disclaimer in the
 *   documentation and/or other materials provided with the distribution.
 *
 * - Neither the name of CodePlex Foundation nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(e){var t;define([],function(){return function(){(function(e){function s(t){t.updateAgain=!1,t.viewer&&t.viewer.raiseEvent("update-viewport",{});var n,r,i=null,s=!1,u=e.now(),a=t.viewport.getContainerSize(),l=t.viewport.getBounds(!0),c=l.getTopLeft(),h=l.getBottomRight(),p=t.viewport.deltaPixelsFromPoints(t.source.getPixelRatio(0),!0).x,d=Math.max(t.source.minLevel,Math.floor(Math.log(t.minZoomImageRatio)/Math.log(2))),m=Math.min(Math.abs(t.source.maxLevel),Math.abs(Math.floor(Math.log(p/t.minPixelRatio)/Math.log(2)))),g=t.viewport.degrees,y,b,E,S,x,T;while(t.lastDrawn.length>0)n=t.lastDrawn.pop(),n.beingDrawn=!1;t.canvas.innerHTML="";if(t.useCanvas){if(t.canvas.width!=a.x||t.canvas.height!=a.y)t.canvas.width=a.x,t.canvas.height=a.y;t.context.clearRect(0,0,a.x,a.y)}if(g===90||g===270){var N=l.rotate(g);c=N.getTopLeft(),h=N.getBottomRight()}else if(g!==0){var C=l.rotate(90);l.x-=C.width/2,l.y-=C.height/2,l.width+=C.width,l.height+=C.height,c=l.getTopLeft(),h=l.getBottomRight()}if(!t.wrapHorizontal&&(h.x<0||c.x>1))return;if(!t.wrapVertical&&(h.y<0||c.y>t.normHeight))return;t.wrapHorizontal||(c.x=Math.max(c.x,0),h.x=Math.min(h.x,1)),t.wrapVertical||(c.y=Math.max(c.y,0),h.y=Math.min(h.y,t.normHeight)),d=Math.min(d,m);var k;for(r=m;r>=d;r--){k=!1,y=t.viewport.deltaPixelsFromPoints(t.source.getPixelRatio(r),!0).x;if(!s&&y>=t.minPixelRatio||r==d)k=!0,s=!0;else if(!s)continue;b=t.viewport.deltaPixelsFromPoints(t.source.getPixelRatio(r),!1).x,E=t.viewport.deltaPixelsFromPoints(t.source.getPixelRatio(Math.max(t.source.getClosestLevel(t.viewport.containerSize)-1,0)),!1).x,S=t.immediateRender?1:E,x=Math.min(1,(y-.5)/.5),T=S/Math.abs(S-b),i=o(t,s,k,r,x,T,c,h,u,i);if(v(t.coverage,r))break}w(t,t.lastDrawn),i&&(f(t,i,u),t.updateAgain=!0)}function o(e,t,n,r,i,s,o,a,f,l){var c,h,p,d,v,m=e.viewport.pixelFromPoint(e.viewport.getCenter());e.viewer&&e.viewer.raiseEvent("update-level",{havedrawn:t,level:r,opacity:i,visibility:s,topleft:o,bottomright:a,currenttime:f,best:l}),p=e.source.getTileAtPoint(r,o),d=e.source.getTileAtPoint(r,a),v=e.source.getNumTiles(r),y(e.coverage,r),e.wrapHorizontal||(d.x=Math.min(d.x,v.x-1)),e.wrapVertical||(d.y=Math.min(d.y,v.y-1));for(c=p.x;c<=d.x;c++)for(h=p.y;h<=d.y;h++)l=u(e,n,t,c,h,r,i,s,m,v,f,l);return l}function u(e,t,n,r,i,s,o,u,f,l,c,d){var v=a(r,i,s,e.source,e.tilesMatrix,c,l,e.normHeight),y=t;e.viewer&&e.viewer.raiseEvent("update-tile",{tile:v}),g(e.coverage,s,r,i,!1);if(!v.exists)return d;n&&!y&&(m(e.coverage,s,r,i)?g(e.coverage,s,r,i,!0):y=!0);if(!y)return d;h(v,e.source.tileOverlap,e.viewport,f,u);if(v.loaded){var w=p(e,v,r,i,s,o,c);w&&(e.updateAgain=!0)}else v.loading||(d=b(d,v));return d}function a(t,n,r,i,s,o,u,a){var f,l,c,h,p,d;return s[r]||(s[r]={}),s[r][t]||(s[r][t]={}),s[r][t][n]||(f=(u.x+t%u.x)%u.x,l=(u.y+n%u.y)%u.y,c=i.getTileBounds(r,f,l),h=i.tileExists(r,f,l),p=i.getTileUrl(r,f,l),c.x+=1*(t-f)/u.x,c.y+=a*(n-l)/u.y,s[r][t][n]=new e.Tile(r,t,n,c,h,p)),d=s[r][t][n],d.lastTouchTime=o,d}function f(e,t,n){e.viewport.collectionMode?(e.midUpdate=!1,l(e,t,n)):(t.loading=!0,e.imageLoader.addJob({src:t.url,crossOriginPolicy:e.crossOriginPolicy,callback:function(r){l(e,t,n,r)}}))}function l(t,n,r,i){n.loading=!1;if(!i&&!t.viewport.collectionMode){e.console.log("Tile %s failed to load: %s",n,n.url);if(!t.debugMode){n.exists=!1;return}}else if(r<t.lastResetTime){e.console.log("Ignoring tile %s loaded before reset: %s",n,n.url);return}n.loaded=!0,n.image=i,t.tilesLoaded.length<t.maxImageCacheCount?t.tilesLoaded[t.tilesLoaded.length]=n:t.midUpdate?window.setTimeout(function(){c(n,t)},1):c(n,t),t.updateAgain=!0}function c(e,t){var n,r,i,s,o,u,a=t.tilesLoaded.length,f=Math.ceil(Math.log(t.source.getTileSize(e.level))/Math.log(2)),l=null,c=-1;for(n=t.tilesLoaded.length-1;n>=0;n--){r=t.tilesLoaded[n];if(r.level<=t.cutoff||r.beingDrawn)continue;if(!l){l=r,c=n;continue}i=r.lastTouchTime,s=l.lastTouchTime,o=r.level,u=l.level;if(i<s||i==s&&o>u)l=r,c=n}l&&c>=0&&(l.unload(),a=c),t.tilesLoaded[a]=e}function h(t,n,r,i,s){var o=t.bounds.getTopLeft(),u=t.bounds.getSize(),a=r.pixelFromPoint(o,!0),f=r.pixelFromPoint(o,!1),l=r.deltaPixelsFromPoints(u,!0),c=r.deltaPixelsFromPoints(u,!1),h=f.plus(c.divide(2)),p=i.distanceTo(h);n||(l=l.plus(new e.Point(1,1))),t.position=a,t.size=l,t.distance=p,t.visibility=s}function p(e,t,n,r,i,s,o){var u=1e3*e.blendTime,a,f;t.blendStart||(t.blendStart=o),a=o-t.blendStart,f=u?Math.min(1,a/u):1,e.alwaysBlend&&(f*=s),t.opacity=f,e.lastDrawn.push(t);if(f==1)g(e.coverage,i,n,r,!0);else if(a<u)return!0;return!1}function d(e){e.tilesMatrix={},e.tilesLoaded=[]}function v(e,t,n,r){var i,s,o,u;if(!e[t])return!1;if(n===undefined||r===undefined){i=e[t];for(o in i)if(i.hasOwnProperty(o)){s=i[o];for(u in s)if(s.hasOwnProperty(u)&&!s[u])return!1}return!0}return e[t][n]===undefined||e[t][n][r]===undefined||e[t][n][r]===!0}function m(e,t,n,r){return n===undefined||r===undefined?v(e,t+1):v(e,t+1,2*n,2*r)&&v(e,t+1,2*n,2*r+1)&&v(e,t+1,2*n+1,2*r)&&v(e,t+1,2*n+1,2*r+1)}function g(t,n,r,i,s){if(!t[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}t[n][r]||(t[n][r]={}),t[n][r][i]=s}function y(e,t){e[t]={}}function b(e,t){return e?t.visibility>e.visibility?t:t.visibility==e.visibility&&t.distance<e.distance?t:e:t}function w(t,n){var r,s,o,u,a,f,l,c,h=function(e){t.viewer&&t.viewer.raiseEvent("tile-drawing",e)};for(r=n.length-1;r>=0;r--){s=n[r],t.viewport.collectionMode?(o=s.x+"/"+s.y,a=t.viewport,c=a.collectionTileSource,t.collectionOverlays[o]?(u=t.collectionOverlays[o],u.viewport&&(u.viewport.resize(s.size,!0),u.viewport.goHome(!0))):(f=c.layout=="horizontal"?s.y+s.x*c.rows:s.x+s.y*c.rows,f<c.tileSources.length?l=c.tileSources[f]:l=null,l&&(t.collectionOverlays[o]=u=new e.Viewer({hash:a.viewer.hash+"-"+o,element:e.makeNeutralElement("div"),mouseNavEnabled:!1,showNavigator:!1,showSequenceControl:!1,showNavigationControl:!1,tileSources:[l]}),i&&(u.element.style.border="1px solid rgba(255,255,255,0.38)",u.element.style["-webkit-box-reflect"]="below 0px -webkit-gradient(linear,left top,left bottom,from(transparent),color-stop(62%,transparent),to(rgba(255,255,255,0.62)))"),t.viewer.addOverlay(u.element,s.bounds)))):(t.useCanvas?t.viewport.degrees!==0?(E(s,t.canvas,t.context,t.viewport.degrees),s.drawCanvas(t.context,h),S(s,t.canvas,t.context)):s.drawCanvas(t.context,h):s.drawHTML(t.canvas),s.beingDrawn=!0);if(t.debugMode)try{x(t,s,n.length,r)}catch(p){e.console.error(p)}t.viewer&&t.viewer.raiseEvent("tile-drawn",{tile:s})}}function E(e,t,n,r){var i=t.width/2,s=t.height/2,o=e.position.x-i,u=e.position.y-s;n.save(),n.translate(i,s),n.rotate(Math.PI/180*r),e.position.x=o,e.position.y=u}function S(e,t,n){var r=t.width/2,i=t.height/2,s=e.position.x+r,o=e.position.y+i;e.position.x=s,e.position.y=o,n.restore()}function x(e,t,n,r){if(e.useCanvas){e.context.save(),e.context.lineWidth=2,e.context.font="small-caps bold 13px ariel",e.context.strokeStyle=e.debugGridColor,e.context.fillStyle=e.debugGridColor,E(t,e.canvas,e.context,e.viewport.degrees),e.context.strokeRect(t.position.x,t.position.y,t.size.x,t.size.y);var i=t.position.x+t.size.x/2,s=t.position.y+t.size.y/2;e.context.translate(i,s),e.context.rotate(Math.PI/180*-e.viewport.degrees),e.context.translate(-i,-s),t.x===0&&t.y===0&&(e.context.fillText("Zoom: "+e.viewport.getZoom(),t.position.x,t.position.y-30),e.context.fillText("Pan: "+e.viewport.getBounds().toString(),t.position.x,t.position.y-20)),e.context.fillText("Level: "+t.level,t.position.x+10,t.position.y+20),e.context.fillText("Column: "+t.x,t.position.x+10,t.position.y+30),e.context.fillText("Row: "+t.y,t.position.x+10,t.position.y+40),e.context.fillText("Order: "+r+" of "+n,t.position.x+10,t.position.y+50),e.context.fillText("Size: "+t.size.toString(),t.position.x+10,t.position.y+60),e.context.fillText("Position: "+t.position.toString(),t.position.x+10,t.position.y+70),S(t,e.canvas,e.context),e.context.restore()}}var t=e.getWindowSize(),n=e.Browser.vendor,r=e.Browser.version,i=n==e.BROWSERS.FIREFOX||n==e.BROWSERS.OPERA||n==e.BROWSERS.SAFARI&&r>=4||n==e.BROWSERS.CHROME&&r>=2||n==e.BROWSERS.IE&&r>=9;e.Drawer=function(t){var n=arguments,r;e.isPlainObject(t)||(t={source:n[0],viewport:n[1],element:n[2]}),e.extend(!0,this,{viewer:null,imageLoader:new e.ImageLoader,tilesMatrix:{},tilesLoaded:[],coverage:{},lastDrawn:[],lastResetTime:0,midUpdate:!1,updateAgain:!0,collectionOverlays:{},opacity:e.DEFAULT_SETTINGS.opacity,maxImageCacheCount:e.DEFAULT_SETTINGS.maxImageCacheCount,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,debugMode:e.DEFAULT_SETTINGS.debugMode,timeout:e.DEFAULT_SETTINGS.timeout,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy},t),this.useCanvas=e.supportsCanvas&&(this.viewer?this.viewer.useCanvas:!0),this.container=e.getElement(this.element),this.canvas=e.makeNeutralElement(this.useCanvas?"canvas":"div"),this.context=this.useCanvas?this.canvas.getContext("2d"):null,this.normHeight=this.source.dimensions.y/this.source.dimensions.x,this.element=this.container,this.container.dir="ltr",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",e.setElementOpacity(this.canvas,this.opacity,!0),this.container.style.textAlign="left",this.container.appendChild(this.canvas)},e.Drawer.prototype={addOverlay:function(t,n,r,i){return e.console.error("drawer.addOverlay is deprecated. Use viewer.addOverlay instead."),this.viewer.addOverlay(t,n,r,i),this},updateOverlay:function(t,n,r){return e.console.error("drawer.updateOverlay is deprecated. Use viewer.updateOverlay instead."),this.viewer.updateOverlay(t,n,r),this},removeOverlay:function(t){return e.console.error("drawer.removeOverlay is deprecated. Use viewer.removeOverlay instead."),this.viewer.removeOverlay(t),this},clearOverlays:function(){return e.console.error("drawer.clearOverlays is deprecated. Use viewer.clearOverlays instead."),this.viewer.clearOverlays(),this},setOpacity:function(t){return this.opacity=t,e.setElementOpacity(this.canvas,this.opacity,!0),this},getOpacity:function(){return this.opacity},needsUpdate:function(){return this.updateAgain},numTilesLoaded:function(){return this.tilesLoaded.length},reset:function(){return d(this),this.lastResetTime=e.now(),this.updateAgain=!0,this},update:function(){return this.midUpdate=!0,s(this),this.midUpdate=!1,this},canRotate:function(){return this.useCanvas},destroy:function(){for(var e=0;e<this.tilesLoaded.length;++e)this.tilesLoaded[e].unload();this.canvas.width=1,this.canvas.height=1}}})(OpenSeadragon)}.call(e),t})})(this);