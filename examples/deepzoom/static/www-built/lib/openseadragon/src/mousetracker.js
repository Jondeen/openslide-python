/*
 * OpenSeadragon - MouseTracker
 *
 * Copyright (C) 2009 CodePlex Foundation
 * Copyright (C) 2010-2013 OpenSeadragon contributors
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * - Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 *
 * - Redistributions in binary form must reproduce the above copyright
 *   notice, this list of conditions and the following disclaimer in the
 *   documentation and/or other materials provided with the distribution.
 *
 * - Neither the name of CodePlex Foundation nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(e){var t;define([],function(){return function(){(function(e){function r(t){var r=n[t.hash],i,s=r.activePointersLists.length;for(i=0;i<s;i++)r.activePointersLists[i].captureCount>0&&(e.removeEvent(e.MouseTracker.captureElement,"mousemove",r.mousemovecaptured,!0),e.removeEvent(e.MouseTracker.captureElement,"mouseup",r.mouseupcaptured,!0),e.removeEvent(e.MouseTracker.captureElement,e.MouseTracker.unprefixedPointerEvents?"pointermove":"MSPointerMove",r.pointermovecaptured,!0),e.removeEvent(e.MouseTracker.captureElement,e.MouseTracker.unprefixedPointerEvents?"pointerup":"MSPointerUp",r.pointerupcaptured,!0),e.removeEvent(e.MouseTracker.captureElement,"touchmove",r.touchmovecaptured,!0),e.removeEvent(e.MouseTracker.captureElement,"touchend",r.touchendcaptured,!0),r.activePointersLists[i].captureCount=0);for(i=0;i<s;i++)r.activePointersLists.pop()}function i(t){var i=n[t.hash],s,o;if(!i.tracking){for(o=0;o<e.MouseTracker.subscribeEvents.length;o++)s=e.MouseTracker.subscribeEvents[o],e.addEvent(t.element,s,i[s],!1);r(t),i.tracking=!0}}function s(t){var i=n[t.hash],s,o;if(i.tracking){for(o=0;o<e.MouseTracker.subscribeEvents.length;o++)s=e.MouseTracker.subscribeEvents[o],e.removeEvent(t.element,s,i[s],!1);r(t),i.tracking=!1}}function o(t,r){var i=n[t.hash];if(r==="pointerevent")return{upName:e.MouseTracker.unprefixedPointerEvents?"pointerup":"MSPointerUp",upHandler:i.pointerupcaptured,moveName:e.MouseTracker.unprefixedPointerEvents?"pointermove":"MSPointerMove",moveHandler:i.pointermovecaptured};if(r==="mouse")return{upName:"mouseup",upHandler:i.mouseupcaptured,moveName:"mousemove",moveHandler:i.mousemovecaptured};if(r==="touch")return{upName:"touchend",upHandler:i.touchendcaptured,moveName:"touchmove",moveHandler:i.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function u(t,n){var r=t.getActivePointersListByType(n),i;r.captureCount++,r.captureCount===1&&(e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?t.element.setCapture(!0):(i=o(t,e.MouseTracker.havePointerEvents?"pointerevent":n),e.addEvent(e.MouseTracker.captureElement,i.upName,i.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,i.moveName,i.moveHandler,!0)))}function a(t,n){var r=t.getActivePointersListByType(n),i;r.captureCount--,r.captureCount===0&&(e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?t.element.releaseCapture():(i=o(t,e.MouseTracker.havePointerEvents?"pointerevent":n),e.removeEvent(e.MouseTracker.captureElement,i.moveName,i.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,i.upName,i.upHandler,!0)))}function f(t){var n;if(e.MouseTracker.unprefixedPointerEvents)n=t.pointerType;else switch(t.pointerType){case 2:n="touch";break;case 3:n="pen";break;case 4:n="mouse";break;default:n=""}return n}function l(t){return e.getMousePosition(t)}function c(e,t){return h(l(e),t)}function h(t,n){var r=e.getElementOffset(n);return t.minus(r)}function p(t,n){return new e.Point((t.x+n.x)/2,(t.y+n.y)/2)}function d(t,n){t.clickHandler&&e.cancelEvent(n)}function v(t,n){t.dblClickHandler&&e.cancelEvent(n)}function m(t,n){var r;t.keyDownHandler&&(n=e.getEvent(n),r=t.keyDownHandler({eventSource:t,keyCode:n.keyCode?n.keyCode:n.charCode,ctrl:n.ctrlKey,shift:n.shiftKey,alt:n.altKey,meta:n.metaKey,originalEvent:n,preventDefaultAction:!1,userData:t.userData}),r||e.cancelEvent(n))}function g(t,n){var r;t.keyUpHandler&&(n=e.getEvent(n),r=t.keyUpHandler({eventSource:t,keyCode:n.keyCode?n.keyCode:n.charCode,ctrl:n.ctrlKey,shift:n.shiftKey,alt:n.altKey,meta:n.metaKey,originalEvent:n,preventDefaultAction:!1,userData:t.userData}),r||e.cancelEvent(n))}function y(t,n){var r;t.keyHandler&&(n=e.getEvent(n),r=t.keyHandler({eventSource:t,keyCode:n.keyCode?n.keyCode:n.charCode,ctrl:n.ctrlKey,shift:n.shiftKey,alt:n.altKey,meta:n.metaKey,originalEvent:n,preventDefaultAction:!1,userData:t.userData}),r||e.cancelEvent(n))}function b(t,n){var r;t.focusHandler&&(n=e.getEvent(n),r=t.focusHandler({eventSource:t,originalEvent:n,preventDefaultAction:!1,userData:t.userData}),r===!1&&e.cancelEvent(n))}function w(t,n){var r;t.blurHandler&&(n=e.getEvent(n),r=t.blurHandler({eventSource:t,originalEvent:n,preventDefaultAction:!1,userData:t.userData}),r===!1&&e.cancelEvent(n))}function E(e,t){x(e,t,t)}function S(t,n){n=e.getEvent(n);var r={target:n.target||n.srcElement,type:"wheel",shiftKey:n.shiftKey||!1,clientX:n.clientX,clientY:n.clientY,pageX:n.pageX?n.pageX:n.clientX,pageY:n.pageY?n.pageY:n.clientY,deltaMode:n.type=="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName=="mousewheel"?r.deltaY=-1/e.DEFAULT_SETTINGS.pixelsPerWheelLine*n.wheelDelta:r.deltaY=n.detail,x(t,r,n)}function x(t,n,r){var i=0,s;i=n.deltaY<0?1:-1,t.scrollHandler&&(s=t.scrollHandler({eventSource:t,pointerType:"mouse",position:c(n,t.element),scroll:i,shift:n.shiftKey,isTouchEvent:!1,originalEvent:r,preventDefaultAction:!1,userData:t.userData}),s===!1&&e.cancelEvent(r))}function T(e,t){if(e===t)return!1;while(t&&t!==e)t=t.parentNode;return t===e}function N(t,n){n=e.getEvent(n),k(t,n)}function C(t,n){n=e.getEvent(n);if(n.currentTarget===n.relatedTarget||T(n.currentTarget,n.relatedTarget))return;k(t,n)}function k(t,n){var r={id:e.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:l(n),currentTime:e.now()};at(t,n,[r])}function L(t,n){n=e.getEvent(n),O(t,n)}function A(t,n){n=e.getEvent(n);if(n.currentTarget===n.relatedTarget||T(n.currentTarget,n.relatedTarget))return;O(t,n)}function O(t,n){var r={id:e.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:l(n),currentTime:e.now()};ft(t,n,[r])}function M(t){return e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?t===1?0:t===2?2:t===4?1:-1:t}function _(t,n){var r;n=e.getEvent(n),r={id:e.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:l(n),currentTime:e.now()},lt(t,n,[r],M(n.button))&&(e.stopEvent(n),u(t,"mouse")),(t.clickHandler||t.dblClickHandler||t.pressHandler||t.dragHandler||t.dragEndHandler)&&e.cancelEvent(n)}function D(e,t){H(e,t)}function P(t,n){H(t,n),e.stopEvent(n)}function H(t,n){var r;n=e.getEvent(n),r={id:e.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:l(n),currentTime:e.now()},ct(t,n,[r],M(n.button))&&a(t,"mouse")}function B(e,t){F(e,t)}function j(t,n){F(t,n),e.stopEvent(n)}function F(t,n){var r;n=e.getEvent(n),r={id:e.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:l(n),currentTime:e.now()},ht(t,n,[r])}function I(e,t,n){var r,i=n.getLength(),s=[];for(r=0;r<i;r++)s.push(n.getByIndex(r));s.length>0&&(ct(e,t,s,0),n.captureCount=1,a(e,"touch"),ft(e,t,s))}function q(n,r){var i,s,o,a=r.changedTouches.length,f=[],c,h=n.getActivePointersListByType("touch");i=e.now(),h.getLength()>r.touches.length-a&&(e.console.warn("Tracked touch contact count doesn't match event.touches.length. Removing all tracked touch pointers."),I(n,r,h));for(s=0;s<a;s++)f.push({id:r.changedTouches[s].identifier,type:"touch",currentPos:l(r.changedTouches[s]),currentTime:i});at(n,r,f);for(s=0;s<t.length;s++)if(t[s]!==n&&t[s].isTracking()&&T(t[s].element,n.element)){c=[];for(o=0;o<a;o++)c.push({id:r.changedTouches[o].identifier,type:"touch",currentPos:l(r.changedTouches[o]),currentTime:i});at(t[s],r,c)}lt(n,r,f,0)&&(e.stopEvent(r),u(n,"touch")),e.cancelEvent(r)}function R(e,t){z(e,t)}function U(t,n){z(t,n),e.stopEvent(n)}function z(n,r){var i,s,o,u=r.changedTouches.length,f=[],c;i=e.now();for(s=0;s<u;s++)f.push({id:r.changedTouches[s].identifier,type:"touch",currentPos:l(r.changedTouches[s]),currentTime:i});ct(n,r,f,0)&&a(n,"touch"),ft(n,r,f);for(s=0;s<t.length;s++)if(t[s]!==n&&t[s].isTracking()&&T(t[s].element,n.element)){c=[];for(o=0;o<u;o++)c.push({id:r.changedTouches[o].identifier,type:"touch",currentPos:l(r.changedTouches[o]),currentTime:i});ft(t[s],r,c)}e.cancelEvent(r)}function W(e,t){V(e,t)}function X(t,n){V(t,n),e.stopEvent(n)}function V(t,n){var r,i=n.changedTouches.length,s=[];for(r=0;r<i;r++)s.push({id:n.changedTouches[r].identifier,type:"touch",currentPos:l(n.changedTouches[r]),currentTime:e.now()});ht(t,n,s),e.cancelEvent(n)}function $(e,t){var n,r=t.changedTouches.length,i=[];for(n=0;n<r;n++)i.push({id:t.changedTouches[n].identifier,type:"touch"});pt(e,t,i)}function J(e,t){return t.stopPropagation(),t.preventDefault(),!1}function K(e,t){return t.stopPropagation(),t.preventDefault(),!1}function Q(t,n){var r;if(n.currentTarget===n.relatedTarget||T(n.currentTarget,n.relatedTarget))return;r={id:n.pointerId,type:f(n),isPrimary:n.isPrimary,currentPos:l(n),currentTime:e.now()},at(t,n,[r])}function G(t,n){var r;if(n.currentTarget===n.relatedTarget||T(n.currentTarget,n.relatedTarget))return;r={id:n.pointerId,type:f(n),isPrimary:n.isPrimary,currentPos:l(n),currentTime:e.now()},ft(t,n,[r])}function Y(t,n){var r;r={id:n.pointerId,type:f(n),isPrimary:n.isPrimary,currentPos:l(n),currentTime:e.now()},lt(t,n,[r],n.button)&&(e.stopEvent(n),u(t,r.type)),(t.clickHandler||t.dblClickHandler||t.pressHandler||t.dragHandler||t.dragEndHandler||t.pinchHandler)&&e.cancelEvent(n)}function Z(e,t){tt(e,t)}function et(t,n){var r=t.getActivePointersListByType(f(n));r.getById(n.pointerId)&&tt(t,n),e.stopEvent(n)}function tt(t,n){var r;r={id:n.pointerId,type:f(n),isPrimary:n.isPrimary,currentPos:l(n),currentTime:e.now()},ct(t,n,[r],n.button)&&a(t,r.type)}function nt(e,t){it(e,t)}function rt(t,n){var r=t.getActivePointersListByType(f(n));r.getById(n.pointerId)&&it(t,n),e.stopEvent(n)}function it(t,n){var r;r={id:n.pointerId,type:f(n),isPrimary:n.isPrimary,currentPos:l(n),currentTime:e.now()},ht(t,n,[r])}function st(e,t){var n;n={id:t.pointerId,type:f(t)},pt(e,t,[n])}function ot(e,t){return t.hasOwnProperty("isPrimary")||(e.getLength()===0?t.isPrimary=!0:t.isPrimary=!1),t.speed=0,t.direction=0,t.contactPos=t.currentPos,t.contactTime=t.currentTime,t.lastPos=t.currentPos,t.lastTime=t.currentTime,e.add(t)}function ut(e,t){var n,r;return e.getById(t.id)?(n=e.removeById(t.id),t.hasOwnProperty("isPrimary")||(r=e.getPrimary(),r||(r=e.getByIndex(0),r&&(r.isPrimary=!0)))):n=e.getLength(),n}function at(t,n,r){var i=t.getActivePointersListByType(r[0].type),s,o=r.length,u,a,f;for(s=0;s<o;s++)u=r[s],a=i.getById(u.id),a?(a.insideElement=!0,a.lastPos=a.currentPos,a.lastTime=a.currentTime,a.currentPos=u.currentPos,a.currentTime=u.currentTime,u=a):(u.captured=!1,u.insideElementPressed=!1,u.insideElement=!0,ot(i,u)),t.enterHandler&&(f=t.enterHandler({eventSource:t,pointerType:u.type,position:h(u.currentPos,t.element),buttons:i.buttons,pointers:t.getActivePointerCount(),insideElementPressed:u.insideElementPressed,buttonDownAny:i.buttons!==0,isTouchEvent:u.type==="touch",originalEvent:n,preventDefaultAction:!1,userData:t.userData}),f===!1&&e.cancelEvent(n))}function ft(t,r,i){var s=n[t.hash],o=t.getActivePointersListByType(i[0].type),u,a=i.length,f,l,c;for(u=0;u<a;u++)f=i[u],l=o.getById(f.id),l&&(l.captured?(l.insideElement=!1,l.lastPos=l.currentPos,l.lastTime=l.currentTime,l.currentPos=f.currentPos,l.currentTime=f.currentTime):ut(o,l),f=l),t.exitHandler&&(c=t.exitHandler({eventSource:t,pointerType:f.type,position:h(f.currentPos,t.element),buttons:o.buttons,pointers:t.getActivePointerCount(),insideElementPressed:l?l.insideElementPressed:!1,buttonDownAny:o.buttons!==0,isTouchEvent:f.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),c===!1&&e.cancelEvent(r))}function lt(t,r,i,s){var o=n[t.hash],u,a=t.getActivePointersListByType(i[0].type),f,l=i.length,c,d;typeof r.buttons!="undefined"?a.buttons=r.buttons:e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?s===0?a.buttons+=1:s===1?a.buttons+=4:s===2?a.buttons+=2:s===3?a.buttons+=8:s===4?a.buttons+=16:s===5&&(a.buttons+=32):s===0?a.buttons|=1:s===1?a.buttons|=4:s===2?a.buttons|=2:s===3?a.buttons|=8:s===4?a.buttons|=16:s===5&&(a.buttons|=32);if(s!==0)return t.nonPrimaryPressHandler&&(u=t.nonPrimaryPressHandler({eventSource:t,pointerType:i[0].type,position:h(i[0].currentPos,t.element),button:s,buttons:a.buttons,isTouchEvent:i[0].type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),u===!1&&e.cancelEvent(r)),!1;for(f=0;f<l;f++)c=i[f],d=a.getById(c.id),d?(d.captured=!0,d.insideElementPressed=!0,d.insideElement=!0,d.contactPos=c.currentPos,d.contactTime=c.currentTime,d.lastPos=d.currentPos,d.lastTime=d.currentTime,d.currentPos=c.currentPos,d.currentTime=c.currentTime,c=d):(c.captured=!0,c.insideElementPressed=!0,c.insideElement=!0,ot(a,c)),a.contacts++,(t.dragHandler||t.dragEndHandler||t.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(t,c),a.contacts===1?t.pressHandler&&(u=t.pressHandler({eventSource:t,pointerType:c.type,position:h(c.contactPos,t.element),buttons:a.buttons,isTouchEvent:c.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),u===!1&&e.cancelEvent(r)):a.contacts===2&&t.pinchHandler&&c.type==="touch"&&(o.pinchGPoints=a.asArray(),o.lastPinchDist=o.currentPinchDist=o.pinchGPoints[0].currentPos.distanceTo(o.pinchGPoints[1].currentPos),o.lastPinchCenter=o.currentPinchCenter=p(o.pinchGPoints[0].currentPos,o.pinchGPoints[1].currentPos));return!0}function ct(t,r,i,s){var o=n[t.hash],u=t.getActivePointersListByType(i[0].type),a,f,l,c,d,v=i.length,m,g,y=!1,b=!1,w;typeof r.buttons!="undefined"?u.buttons=r.buttons:e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?s===0?u.buttons-=1:s===1?u.buttons-=4:s===2?u.buttons-=2:s===3?u.buttons-=8:s===4?u.buttons-=16:s===5&&(u.buttons-=32):s===0?u.buttons^=-2:s===1?u.buttons^=-5:s===2?u.buttons^=-3:s===3?u.buttons^=-9:s===4?u.buttons^=-17:s===5&&(u.buttons^=-33);if(s!==0)return t.nonPrimaryReleaseHandler&&(a=t.nonPrimaryReleaseHandler({eventSource:t,pointerType:i[0].type,position:h(i[0].currentPos,t.element),button:s,buttons:u.buttons,isTouchEvent:i[0].type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)),!1;for(d=0;d<v;d++)m=i[d],g=u.getById(m.id),g&&(g.captured&&(g.captured=!1,y=!0,b=!0),g.lastPos=g.currentPos,g.lastTime=g.currentTime,g.currentPos=m.currentPos,g.currentTime=m.currentTime,g.insideElement||ut(u,g),l=g.currentPos,c=g.currentTime,b?(u.contacts--,(t.dragHandler||t.dragEndHandler||t.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(t,g),u.contacts===0?(t.releaseHandler&&(a=t.releaseHandler({eventSource:t,pointerType:g.type,position:h(l,t.element),buttons:u.buttons,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElement,isTouchEvent:g.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)),t.dragEndHandler&&!g.currentPos.equals(g.contactPos)&&(a=t.dragEndHandler({eventSource:t,pointerType:g.type,position:h(g.currentPos,t.element),speed:g.speed,direction:g.direction,shift:r.shiftKey,isTouchEvent:g.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)),(t.clickHandler||t.dblClickHandler)&&g.insideElement&&(w=c-g.contactTime<=t.clickTimeThreshold&&g.contactPos.distanceTo(l)<=t.clickDistThreshold,t.clickHandler&&(a=t.clickHandler({eventSource:t,pointerType:g.type,position:h(g.currentPos,t.element),quick:w,shift:r.shiftKey,isTouchEvent:g.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)),t.dblClickHandler&&w&&(u.clicks++,u.clicks===1?(o.lastClickPos=l,o.dblClickTimeOut=setTimeout(function(){u.clicks=0},t.dblClickTimeThreshold)):u.clicks===2&&(clearTimeout(o.dblClickTimeOut),u.clicks=0,o.lastClickPos.distanceTo(l)<=t.dblClickDistThreshold&&(a=t.dblClickHandler({eventSource:t,pointerType:g.type,position:h(g.currentPos,t.element),shift:r.shiftKey,isTouchEvent:g.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)),o.lastClickPos=null)))):u.contacts===2&&t.pinchHandler&&g.type==="touch"&&(o.pinchGPoints=u.asArray(),o.lastPinchDist=o.currentPinchDist=o.pinchGPoints[0].currentPos.distanceTo(o.pinchGPoints[1].currentPos),o.lastPinchCenter=o.currentPinchCenter=p(o.pinchGPoints[0].currentPos,o.pinchGPoints[1].currentPos))):t.releaseHandler&&(a=t.releaseHandler({eventSource:t,pointerType:g.type,position:h(l,t.element),buttons:u.buttons,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElement,isTouchEvent:g.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),a===!1&&e.cancelEvent(r)));return y}function ht(t,r,i){var s=n[t.hash],o=t.getActivePointersListByType(i[0].type),u,a=i.length,f,l,c,d,v;typeof r.buttons!="undefined"&&(o.buttons=r.buttons);for(u=0;u<a;u++)f=i[u],l=o.getById(f.id),l?(f.hasOwnProperty("isPrimary")&&(l.isPrimary=f.isPrimary),l.lastPos=l.currentPos,l.lastTime=l.currentTime,l.currentPos=f.currentPos,l.currentTime=f.currentTime):(f.captured=!1,f.insideElementPressed=!1,f.insideElement=!0,ot(o,f));t.stopHandler&&i[0].type==="mouse"&&(clearTimeout(t.stopTimeOut),t.stopTimeOut=setTimeout(function(){dt(t,r,i[0].type)},t.stopDelay)),o.contacts===0?t.moveHandler&&(v=t.moveHandler({eventSource:t,pointerType:i[0].type,position:h(i[0].currentPos,t.element),buttons:o.buttons,isTouchEvent:i[0].type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),v===!1&&e.cancelEvent(r)):o.contacts===1?(t.moveHandler&&(l=o.asArray()[0],v=t.moveHandler({eventSource:t,pointerType:l.type,position:h(l.currentPos,t.element),buttons:o.buttons,isTouchEvent:l.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),v===!1&&e.cancelEvent(r)),t.dragHandler&&(l=o.asArray()[0],d=l.currentPos.minus(l.lastPos),v=t.dragHandler({eventSource:t,pointerType:l.type,position:h(l.currentPos,t.element),buttons:o.buttons,delta:d,speed:l.speed,direction:l.direction,shift:r.shiftKey,isTouchEvent:l.type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),v===!1&&e.cancelEvent(r))):o.contacts===2&&(t.moveHandler&&(c=o.asArray(),v=t.moveHandler({eventSource:t,pointerType:c[0].type,position:h(p(c[0].currentPos,c[1].currentPos),t.element),buttons:o.buttons,isTouchEvent:c[0].type==="touch",originalEvent:r,preventDefaultAction:!1,userData:t.userData}),v===!1&&e.cancelEvent(r)),t.pinchHandler&&i[0].type==="touch"&&(d=s.pinchGPoints[0].currentPos.distanceTo(s.pinchGPoints[1].currentPos),d!=s.currentPinchDist&&(s.lastPinchDist=s.currentPinchDist,s.currentPinchDist=d,s.lastPinchCenter=s.currentPinchCenter,s.currentPinchCenter=p(s.pinchGPoints[0].currentPos,s.pinchGPoints[1].currentPos),v=t.pinchHandler({eventSource:t,pointerType:"touch",gesturePoints:s.pinchGPoints,lastCenter:h(s.lastPinchCenter,t.element),center:h(s.currentPinchCenter,t.element),lastDistance:s.lastPinchDist,distance:s.currentPinchDist,shift:r.shiftKey,originalEvent:r,preventDefaultAction:!1,userData:t.userData}),v===!1&&e.cancelEvent(r))))}function pt(e,t,n){ct(e,t,n,0),ft(e,t,n)}function dt(e,t,n){e.stopHandler&&e.stopHandler({eventSource:e,pointerType:n,position:c(t,e.element),buttons:e.getActivePointersListByType(n).buttons,isTouchEvent:n==="touch",originalEvent:t,preventDefaultAction:!1,userData:e.userData})}var t=[],n={};e.MouseTracker=function(r){t.push(this);var i=arguments;e.isPlainObject(r)||(r={element:i[0],clickTimeThreshold:i[1],clickDistThreshold:i[2]}),this.hash=Math.random(),this.element=e.getElement(r.element),this.clickTimeThreshold=r.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=r.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=r.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=r.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=r.userData||null,this.stopDelay=r.stopDelay||50,this.enterHandler=r.enterHandler||null,this.exitHandler=r.exitHandler||null,this.pressHandler=r.pressHandler||null,this.nonPrimaryPressHandler=r.nonPrimaryPressHandler||null,this.releaseHandler=r.releaseHandler||null,this.nonPrimaryReleaseHandler=r.nonPrimaryReleaseHandler||null,this.moveHandler=r.moveHandler||null,this.scrollHandler=r.scrollHandler||null,this.clickHandler=r.clickHandler||null,this.dblClickHandler=r.dblClickHandler||null,this.dragHandler=r.dragHandler||null,this.dragEndHandler=r.dragEndHandler||null,this.pinchHandler=r.pinchHandler||null,this.stopHandler=r.stopHandler||null,this.keyDownHandler=r.keyDownHandler||null,this.keyUpHandler=r.keyUpHandler||null,this.keyHandler=r.keyHandler||null,this.focusHandler=r.focusHandler||null,this.blurHandler=r.blurHandler||null;var s=this;n[this.hash]={click:function(e){d(s,e)},dblclick:function(e){v(s,e)},keydown:function(e){m(s,e)},keyup:function(e){g(s,e)},keypress:function(e){y(s,e)},focus:function(e){b(s,e)},blur:function(e){w(s,e)},wheel:function(e){E(s,e)},mousewheel:function(e){S(s,e)},DOMMouseScroll:function(e){S(s,e)},MozMousePixelScroll:function(e){S(s,e)},mouseenter:function(e){N(s,e)},mouseleave:function(e){L(s,e)},mouseover:function(e){C(s,e)},mouseout:function(e){A(s,e)},mousedown:function(e){_(s,e)},mouseup:function(e){D(s,e)},mouseupcaptured:function(e){P(s,e)},mousemove:function(e){B(s,e)},mousemovecaptured:function(e){j(s,e)},touchstart:function(e){q(s,e)},touchend:function(e){R(s,e)},touchendcaptured:function(e){U(s,e)},touchmove:function(e){W(s,e)},touchmovecaptured:function(e){X(s,e)},touchcancel:function(e){$(s,e)},gesturestart:function(e){J(s,e)},gesturechange:function(e){K(s,e)},pointerover:function(e){Q(s,e)},MSPointerOver:function(e){Q(s,e)},pointerout:function(e){G(s,e)},MSPointerOut:function(e){G(s,e)},pointerdown:function(e){Y(s,e)},MSPointerDown:function(e){Y(s,e)},pointerup:function(e){Z(s,e)},MSPointerUp:function(e){Z(s,e)},pointermove:function(e){nt(s,e)},MSPointerMove:function(e){nt(s,e)},pointercancel:function(e){st(s,e)},MSPointerCancel:function(e){st(s,e)},pointerupcaptured:function(e){et(s,e)},pointermovecaptured:function(e){rt(s,e)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null},r.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){var e;s(this),this.element=null;for(e=0;e<t.length;e++)if(t[e]===this){t.splice(e,1);break}n[this.hash]=null,delete n[this.hash]},isTracking:function(){return n[this.hash].tracking},setTracking:function(e){return e?i(this):s(this),this},getActivePointersListByType:function(t){var r=n[this.hash],i,s=r.activePointersLists.length,o;for(i=0;i<s;i++)if(r.activePointersLists[i].type===t)return r.activePointersLists[i];return o=new e.MouseTracker.GesturePointList(t),r.activePointersLists.push(o),o},getActivePointerCount:function(){var e=n[this.hash],t,r=e.activePointersLists.length,i=0;for(t=0;t<r;t++)i+=e.activePointersLists[t].getLength();return i},enterHandler:function(){},exitHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}},e.MouseTracker.gesturePointVelocityTracker=function(){var t=[],n=0,r=0,i=function(e,t){return e.hash.toString()+t.type+t.id.toString()},s=function(){var n,i=t.length,s,o,u=e.now(),a,f,l;a=u-r,r=u;for(n=0;n<i;n++)s=t[n],o=s.gPoint,o.direction=Math.atan2(o.currentPos.y-s.lastPos.y,o.currentPos.x-s.lastPos.x),f=s.lastPos.distanceTo(o.currentPos),s.lastPos=o.currentPos,l=1e3*f/(a+1),o.speed=.75*l+.25*o.speed},o=function(o,u){var a=i(o,u);t.push({guid:a,gPoint:u,lastPos:u.currentPos}),t.length===1&&(r=e.now(),n=window.setInterval(s,50))},u=function(e,r){var s=i(e,r),o,u=t.length;for(o=0;o<u;o++)if(t[o].guid===s){t.splice(o,1),u--,u===0&&window.clearInterval(n);break}};return{addPoint:o,removePoint:u}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName=e.Browser.vendor==e.BROWSERS.IE&&e.Browser.version>8||"onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll",e.MouseTracker.supportsMouseCapture=function(){var t=document.createElement("div");return e.isFunction(t.setCapture)&&e.isFunction(t.releaseCapture)}(),e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName=="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent&&(window.navigator.pointerEnabled||e.Browser.vendor!==e.BROWSERS.IE)?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.unprefixedPointerEvents=!0,navigator.maxTouchPoints?e.MouseTracker.maxTouchPoints=navigator.maxTouchPoints:e.MouseTracker.maxTouchPoints=0,e.MouseTracker.haveMouseEnter=!1):window.MSPointerEvent&&window.navigator.msPointerEnabled?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("MSPointerOver","MSPointerOut","MSPointerDown","MSPointerUp","MSPointerMove","MSPointerCancel"),e.MouseTracker.unprefixedPointerEvents=!1,navigator.msMaxTouchPoints?e.MouseTracker.maxTouchPoints=navigator.msMaxTouchPoints:e.MouseTracker.maxTouchPoints=0,e.MouseTracker.haveMouseEnter=!1):(e.MouseTracker.havePointerEvents=!1,e.Browser.vendor===e.BROWSERS.IE&&e.Browser.version<9?(e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave"),e.MouseTracker.haveMouseEnter=!0):(e.MouseTracker.subscribeEvents.push("mouseover","mouseout"),e.MouseTracker.haveMouseEnter=!1),e.MouseTracker.subscribeEvents.push("mousedown","mouseup","mousemove"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.maxTouchPoints=10),e.MouseTracker.GesturePointList=function(e){this._gPoints=[],this.type=e,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(e){return this._gPoints.push(e)},removeById:function(e){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].id===e){this._gPoints.splice(t,1);break}return this._gPoints.length},getByIndex:function(e){return e<this._gPoints.length?this._gPoints[e]:null},getById:function(e){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].id===e)return this._gPoints[t];return null},getPrimary:function(e){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].isPrimary)return this._gPoints[t];return null}}})(OpenSeadragon)}.call(e),t})})(this);