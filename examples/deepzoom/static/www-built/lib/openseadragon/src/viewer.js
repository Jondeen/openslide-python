/*
 * OpenSeadragon - Viewer
 *
 * Copyright (C) 2009 CodePlex Foundation
 * Copyright (C) 2010-2013 OpenSeadragon contributors
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * - Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 *
 * - Redistributions in binary form must reproduce the above copyright
 *   notice, this list of conditions and the following disclaimer in the
 *   documentation and/or other materials provided with the distribution.
 *
 * - Neither the name of CodePlex Foundation nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(root){var amdExports;define([],function(){return function(){(function($){function _getSafeElemSize(e){return e=$.getElement(e),new $.Point(e.clientWidth===0?1:e.clientWidth,e.clientHeight===0?1:e.clientHeight)}function getTileSourceImplementation(viewer,tileSource,successCallback,failCallback){var _this=viewer;$.type(tileSource)=="string"&&(tileSource.match(/\s*<.*/)?tileSource=$.parseXml(tileSource):tileSource.match(/\s*[\{\[].*/)&&(tileSource=eval("("+tileSource+")"))),setTimeout(function(){if($.type(tileSource)=="string")tileSource=new $.TileSource(tileSource,function(e){successCallback(e.tileSource)}),tileSource.addHandler("open-failed",function(e){failCallback(e)});else if($.isPlainObject(tileSource)||tileSource.nodeType)if($.isFunction(tileSource.getTileUrl)){var e=new $.TileSource(tileSource);e.getTileUrl=tileSource.getTileUrl,successCallback(e)}else{var t=$.TileSource.determineType(_this,tileSource);if(!t){failCallback({message:"Unable to load TileSource",source:tileSource});return}var n=t.prototype.configure.apply(_this,[tileSource]),r=new t(n);successCallback(r)}else successCallback(tileSource)},1)}function openTileSource(e,t){var n,r=e;return r.source&&r.close(),THIS[r.hash].prevContainerSize=_getSafeElemSize(r.container),r.collectionMode?(r.source=new $.TileSourceCollection({rows:r.collectionRows,layout:r.collectionLayout,tileSize:r.collectionTileSize,tileSources:r.tileSources,tileMargin:r.collectionTileMargin}),r.viewport=r.viewport?r.viewport:new $.Viewport({collectionMode:!0,collectionTileSource:r.source,containerSize:THIS[r.hash].prevContainerSize,contentSize:r.source.dimensions,springStiffness:r.springStiffness,animationTime:r.animationTime,showNavigator:!1,minZoomImageRatio:1,maxZoomPixelRatio:1,viewer:r,degrees:r.degrees})):(t&&(r.source=t),r.viewport=r.viewport?r.viewport:new $.Viewport({containerSize:THIS[r.hash].prevContainerSize,contentSize:r.source.dimensions,springStiffness:r.springStiffness,animationTime:r.animationTime,minZoomImageRatio:r.minZoomImageRatio,maxZoomPixelRatio:r.maxZoomPixelRatio,visibilityRatio:r.visibilityRatio,wrapHorizontal:r.wrapHorizontal,wrapVertical:r.wrapVertical,defaultZoomLevel:r.defaultZoomLevel,minZoomLevel:r.minZoomLevel,maxZoomLevel:r.maxZoomLevel,viewer:r,degrees:r.degrees,navigatorRotate:r.navigatorRotate,homeFillsViewer:r.homeFillsViewer})),r.preserveViewport&&r.viewport.resetContentSize(r.source.dimensions),r.preserveOverlays&&(r.overlays=r.currentOverlays),r.source.overlays=r.source.overlays||[],r.drawer=new $.Drawer({viewer:r,source:r.source,viewport:r.viewport,element:r.drawersContainer,opacity:r.opacity,maxImageCacheCount:r.maxImageCacheCount,imageLoaderLimit:r.imageLoaderLimit,minZoomImageRatio:r.minZoomImageRatio,wrapHorizontal:r.wrapHorizontal,wrapVertical:r.wrapVertical,immediateRender:r.immediateRender,blendTime:r.blendTime,alwaysBlend:r.alwaysBlend,minPixelRatio:r.collectionMode?0:r.minPixelRatio,timeout:r.timeout,debugMode:r.debugMode,debugGridColor:r.debugGridColor,crossOriginPolicy:r.crossOriginPolicy}),r.drawers=[r.drawer],r.drawer.canRotate()||(r.rotateLeft&&(n=r.buttons.buttons.indexOf(r.rotateLeft),r.buttons.buttons.splice(n,1),r.buttons.element.removeChild(r.rotateLeft.element)),r.rotateRight&&(n=r.buttons.buttons.indexOf(r.rotateRight),r.buttons.buttons.splice(n,1),r.buttons.element.removeChild(r.rotateRight.element))),r.showNavigator&&!r.collectionMode&&(r.navigator?r.navigator.open(t):r.navigator=new $.Navigator({id:r.navigatorId,position:r.navigatorPosition,sizeRatio:r.navigatorSizeRatio,maintainSizeRatio:r.navigatorMaintainSizeRatio,top:r.navigatorTop,left:r.navigatorLeft,width:r.navigatorWidth,height:r.navigatorHeight,autoResize:r.navigatorAutoResize,tileSources:t,tileHost:r.tileHost,prefixUrl:r.prefixUrl,viewer:r,navigatorRotate:r.navigatorRotate})),r.showReferenceStrip&&!r.referenceStrip&&(r.referenceStrip=new $.ReferenceStrip({id:r.referenceStripElement,position:r.referenceStripPosition,sizeRatio:r.referenceStripSizeRatio,scroll:r.referenceStripScroll,height:r.referenceStripHeight,width:r.referenceStripWidth,tileSources:r.tileSources,tileHost:r.tileHost,prefixUrl:r.prefixUrl,viewer:r})),THIS[r.hash].animating=!1,THIS[r.hash].forceRedraw=!0,r._updateRequestId=scheduleUpdate(r,updateMulti),VIEWERS[r.hash]=r,loadOverlays(r),r.raiseEvent("open",{source:t}),r}function loadOverlays(e){e.currentOverlays=[];for(var t=0;t<e.overlays.length;t++)e.currentOverlays[t]=getOverlayObject(e,e.overlays[t]);for(var n=0;n<e.source.overlays.length;n++)e.currentOverlays[t+n]=getOverlayObject(e,e.source.overlays[n])}function getOverlayObject(e,t){if(t instanceof $.Overlay)return t;var n=null;if(t.element)n=$.getElement(t.element);else{var r=t.id?t.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);n=$.getElement(t.id),n||(n=document.createElement("a"),n.href="#/overlay/"+r),n.id=r,$.addClass(n,t.className?t.className:"openseadragon-overlay")}var i=t.location;i||(t.width&&t.height?i=t.px!==undefined?e.viewport.imageToViewportRectangle(new $.Rect(t.px,t.py,t.width,t.height)):new $.Rect(t.x,t.y,t.width,t.height):i=t.px!==undefined?e.viewport.imageToViewportCoordinates(new $.Point(t.px,t.py)):new $.Point(t.x,t.y));var s=t.placement;return s&&$.type(s)==="string"&&(s=$.OverlayPlacement[t.placement.toUpperCase()]),new $.Overlay({element:n,location:i,placement:s,onDraw:t.onDraw,checkResize:t.checkResize})}function getOverlayIndex(e,t){var n;for(n=e.length-1;n>=0;n--)if(e[n].element===t)return n;return-1}function drawOverlays(e,t,n){var r,i=t.length;for(r=0;r<i;r++)t[r].drawHTML(n,e)}function scheduleUpdate(e,t){return $.requestAnimationFrame(function(){t(e)})}function scheduleControlsFade(e){$.requestAnimationFrame(function(){updateControlsFade(e)})}function beginControlsAutoHide(e){if(!e.autoHideControls)return;e.controlsShouldFade=!0,e.controlsFadeBeginTime=$.now()+e.controlsFadeDelay,window.setTimeout(function(){scheduleControlsFade(e)},e.controlsFadeDelay)}function updateControlsFade(e){var t,n,r,i;if(e.controlsShouldFade){t=$.now(),n=t-e.controlsFadeBeginTime,r=1-n/e.controlsFadeLength,r=Math.min(1,r),r=Math.max(0,r);for(i=e.controls.length-1;i>=0;i--)e.controls[i].autoFade&&e.controls[i].setOpacity(r);r>0&&scheduleControlsFade(e)}}function abortControlsAutoHide(e){var t;e.controlsShouldFade=!1;for(t=e.controls.length-1;t>=0;t--)e.controls[t].setOpacity(1)}function onFocus(){abortControlsAutoHide(this)}function onBlur(){beginControlsAutoHide(this)}function onCanvasKeyDown(e){if(!(!e.preventDefaultAction&&!e.ctrl&&!e.alt&&!e.meta))return!0;switch(e.keyCode){case 38:return e.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(new $.Point(0,-0.05)),this.viewport.applyConstraints(),!1;case 40:return e.shift?this.viewport.zoomBy(.9):this.viewport.panBy(new $.Point(0,.05)),this.viewport.applyConstraints(),!1;case 37:return this.viewport.panBy(new $.Point(-0.05,0)),this.viewport.applyConstraints(),!1;case 39:return this.viewport.panBy(new $.Point(.05,0)),this.viewport.applyConstraints(),!1;default:return!0}}function onCanvasKeyPress(e){if(!(!e.preventDefaultAction&&!e.ctrl&&!e.alt&&!e.meta))return!0;switch(e.keyCode){case 61:return this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),!1;case 45:return this.viewport.zoomBy(.9),this.viewport.applyConstraints(),!1;case 48:return this.viewport.goHome(),this.viewport.applyConstraints(),!1;case 119:case 87:return e.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(new $.Point(0,-0.05)),this.viewport.applyConstraints(),!1;case 115:case 83:return e.shift?this.viewport.zoomBy(.9):this.viewport.panBy(new $.Point(0,.05)),this.viewport.applyConstraints(),!1;case 97:return this.viewport.panBy(new $.Point(-0.05,0)),this.viewport.applyConstraints(),!1;case 100:return this.viewport.panBy(new $.Point(.05,0)),this.viewport.applyConstraints(),!1;default:return!0}}function onCanvasClick(e){var t,n=document.activeElement==this.canvas;n||this.canvas.focus(),!e.preventDefaultAction&&this.viewport&&e.quick&&(t=this.gestureSettingsByDeviceType(e.pointerType),t.clickToZoom&&(this.viewport.zoomBy(e.shift?1/this.zoomPerClick:this.zoomPerClick,this.viewport.pointFromPixel(e.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-click",{tracker:e.eventSource,position:e.position,quick:e.quick,shift:e.shift,originalEvent:e.originalEvent})}function onCanvasDblClick(e){var t;!e.preventDefaultAction&&this.viewport&&(t=this.gestureSettingsByDeviceType(e.pointerType),t.dblClickToZoom&&(this.viewport.zoomBy(e.shift?1/this.zoomPerClick:this.zoomPerClick,this.viewport.pointFromPixel(e.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-double-click",{tracker:e.eventSource,position:e.position,shift:e.shift,originalEvent:e.originalEvent})}function onCanvasDrag(e){var t;!e.preventDefaultAction&&this.viewport&&(t=this.gestureSettingsByDeviceType(e.pointerType),this.panHorizontal||(e.delta.x=0),this.panVertical||(e.delta.y=0),this.viewport.panBy(this.viewport.deltaPointsFromPixels(e.delta.negate()),t.flickEnabled),this.constrainDuringPan&&this.viewport.applyConstraints()),this.raiseEvent("canvas-drag",{tracker:e.eventSource,position:e.position,delta:e.delta,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent})}function onCanvasDragEnd(e){var t;if(!e.preventDefaultAction&&this.viewport){t=this.gestureSettingsByDeviceType(e.pointerType);if(t.flickEnabled&&e.speed>=t.flickMinSpeed){var n=t.flickMomentum*e.speed*Math.cos(e.direction-Math.PI/180*this.viewport.degrees),r=t.flickMomentum*e.speed*Math.sin(e.direction-Math.PI/180*this.viewport.degrees),i=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),s=this.viewport.pointFromPixel(new $.Point(i.x-n,i.y-r));this.panHorizontal||(s.x=i.x),this.panVertical||(s.y=i.y),this.viewport.panTo(s,!1)}this.viewport.applyConstraints()}this.raiseEvent("canvas-drag-end",{tracker:e.eventSource,position:e.position,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent})}function onCanvasEnter(e){this.raiseEvent("canvas-enter",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function onCanvasExit(e){this.raiseEvent("canvas-exit",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function onCanvasPress(e){this.raiseEvent("canvas-press",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,insideElementPressed:e.insideElementPressed,insideElementReleased:e.insideElementReleased,originalEvent:e.originalEvent})}function onCanvasRelease(e){this.raiseEvent("canvas-release",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,insideElementPressed:e.insideElementPressed,insideElementReleased:e.insideElementReleased,originalEvent:e.originalEvent})}function onCanvasNonPrimaryPress(e){this.raiseEvent("canvas-nonprimary-press",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function onCanvasNonPrimaryRelease(e){this.raiseEvent("canvas-nonprimary-release",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function onCanvasPinch(e){var t,n,r,i;if(!e.preventDefaultAction&&this.viewport){t=this.gestureSettingsByDeviceType(e.pointerType),t.pinchToZoom&&(n=this.viewport.pointFromPixel(e.center,!0),r=this.viewport.pointFromPixel(e.lastCenter,!0),i=r.minus(n),this.panHorizontal||(i.x=0),this.panVertical||(i.y=0),this.viewport.zoomBy(e.distance/e.lastDistance,n,!0),this.viewport.panBy(i,!0),this.viewport.applyConstraints());if(t.pinchRotate){var s=Math.atan2(e.gesturePoints[0].currentPos.y-e.gesturePoints[1].currentPos.y,e.gesturePoints[0].currentPos.x-e.gesturePoints[1].currentPos.x),o=Math.atan2(e.gesturePoints[0].lastPos.y-e.gesturePoints[1].lastPos.y,e.gesturePoints[0].lastPos.x-e.gesturePoints[1].lastPos.x);this.viewport.setRotation(this.viewport.getRotation()+(s-o)*(180/Math.PI))}}return this.raiseEvent("canvas-pinch",{tracker:e.eventSource,gesturePoints:e.gesturePoints,lastCenter:e.lastCenter,center:e.center,lastDistance:e.lastDistance,distance:e.distance,shift:e.shift,originalEvent:e.originalEvent}),!1}function onCanvasScroll(e){var t,n;return!e.preventDefaultAction&&this.viewport&&(t=this.gestureSettingsByDeviceType(e.pointerType),t.scrollToZoom&&(n=Math.pow(this.zoomPerScroll,e.scroll),this.viewport.zoomBy(n,this.viewport.pointFromPixel(e.position,!0)),this.viewport.applyConstraints())),this.raiseEvent("canvas-scroll",{tracker:e.eventSource,position:e.position,scroll:e.scroll,shift:e.shift,originalEvent:e.originalEvent}),!1}function onContainerEnter(e){THIS[this.hash].mouseInside=!0,abortControlsAutoHide(this),this.raiseEvent("container-enter",{tracker:e.eventSource,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function onContainerExit(e){e.pointers<1&&(THIS[this.hash].mouseInside=!1,THIS[this.hash].animating||beginControlsAutoHide(this)),this.raiseEvent("container-exit",{tracker:e.eventSource,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function updateMulti(e){if(!e.source){e._updateRequestId=null;return}updateOnce(e),e.source&&(e._updateRequestId=scheduleUpdate(e,updateMulti))}function updateOnce(e){var t,n;if(!e.source)return;if(e.autoResize){t=_getSafeElemSize(e.container);if(!t.equals(THIS[e.hash].prevContainerSize)){var r=e.viewport.getBounds(),i=e.viewport.getCenter();resizeViewportAndRecenter(e,t,r,i),THIS[e.hash].prevContainerSize=t,THIS[e.hash].forceRedraw=!0}}n=e.viewport.update(),e.referenceStrip&&(n=e.referenceStrip.update(e.viewport)||n),!THIS[e.hash].animating&&n&&(e.raiseEvent("animation-start"),abortControlsAutoHide(e));if(n)updateDrawers(e),drawOverlays(e.viewport,e.currentOverlays,e.overlaysContainer),e.navigator&&e.navigator.update(e.viewport),e.raiseEvent("animation");else if(THIS[e.hash].forceRedraw||drawersNeedUpdate(e))updateDrawers(e),drawOverlays(e.viewport,e.currentOverlays,e.overlaysContainer),e.navigator&&e.navigator.update(e.viewport),THIS[e.hash].forceRedraw=!1;THIS[e.hash].animating&&!n&&(e.raiseEvent("animation-finish"),THIS[e.hash].mouseInside||beginControlsAutoHide(e)),THIS[e.hash].animating=n}function resizeViewportAndRecenter(e,t,n,r){var i=e.viewport;i.resize(t,!0);var s=1/e.source.aspectRatio,o=n.width<=1?n.width:1,u=n.height<=s?n.height:s,a=new $.Rect(r.x-o/2,r.y-u/2,o,u);i.fitBounds(a,!0)}function updateDrawers(e){for(var t=0;t<e.drawers.length;t++)e.drawers[t].update()}function drawersNeedUpdate(e){for(var t=0;t<e.drawers.length;t++)if(e.drawers[t].needsUpdate())return!0;return!1}function resolveUrl(e,t){return e?e+t:t}function beginZoomingIn(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function beginZoomingOut(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=1/this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function endZooming(){THIS[this.hash].zooming=!1}function scheduleZoom(e){$.requestAnimationFrame($.delegate(e,doZoom))}function doZoom(){var e,t,n;THIS[this.hash].zooming&&this.viewport&&(e=$.now(),t=e-THIS[this.hash].lastZoomTime,n=Math.pow(THIS[this.hash].zoomFactor,t/1e3),this.viewport.zoomBy(n),this.viewport.applyConstraints(),THIS[this.hash].lastZoomTime=e,scheduleZoom(this))}function doSingleZoomIn(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function doSingleZoomOut(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function lightUp(){this.buttons.emulateEnter(),this.buttons.emulateExit()}function onHome(){this.viewport&&this.viewport.goHome()}function onFullScreen(){this.isFullPage()&&!$.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttons&&this.buttons.emulateExit(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function onRotateLeft(){if(this.viewport){var e=this.viewport.getRotation();e===0?e=270:e-=90,this.viewport.setRotation(e)}}function onRotateRight(){if(this.viewport){var e=this.viewport.getRotation();e===270?e=0:e+=90,this.viewport.setRotation(e)}}function onPrevious(){var e=THIS[this.hash].sequence-1;this.navPrevNextWrap&&e<0&&(e+=this.tileSources.length),this.goToPage(e)}function onNext(){var e=THIS[this.hash].sequence+1;this.navPrevNextWrap&&e>=this.tileSources.length&&(e=0),this.goToPage(e)}var THIS={},VIEWERS={};$.Viewer=function(e){var t=arguments,n=this,r;$.isPlainObject(e)||(e={id:t[0],xmlPath:t.length>1?t[1]:undefined,prefixUrl:t.length>2?t[2]:undefined,controls:t.length>3?t[3]:undefined,overlays:t.length>4?t[4]:undefined}),e.config&&($.extend(!0,e,e.config),delete e.config),$.extend(!0,this,{id:e.id,hash:e.hash||e.id,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,drawers:[],drawersContainer:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttons:null,profiler:null},$.DEFAULT_SETTINGS,e);if(typeof this.hash=="undefined")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof THIS[this.hash]!="undefined"&&$.console.warn("Hash "+this.hash+" has already been used."),THIS[this.hash]={fsBoundsDelta:new $.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,sequenced:!1,sequence:0,fullPage:!1,onfullscreenchange:null},this._updateRequestId=null,this.currentOverlays=[],$.EventSource.call(this),this.addHandler("open-failed",function(e){var t=$.getString("Errors.OpenFailed",e.eventSource,e.message);n._showMessage(t)}),$.ControlDock.call(this,e);var i;this.xmlPath&&(this.tileSources=[this.xmlPath]),this.tileSources&&($.isArray(this.tileSources)?(this.tileSources.length>1&&(THIS[this.hash].sequenced=!0),this.initialPage>this.tileSources.length-1&&(this.initialPage=this.tileSources.length-1),i=this.tileSources[this.initialPage],THIS[this.hash].sequence=this.initialPage):i=this.tileSources),this.element=this.element||document.getElementById(this.id),this.canvas=$.makeNeutralElement("div"),this.drawersContainer=$.makeNeutralElement("div"),this.overlaysContainer=$.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(e){e.width="100%",e.height="100%",e.overflow="hidden",e.position="absolute",e.top="0px",e.left="0px"}(this.canvas.style),$.setElementTouchActionNone(this.canvas),this.canvas.tabIndex=e.tabIndex||0,this.container.className="openseadragon-container",function(e){e.width="100%",e.height="100%",e.position="relative",e.overflow="hidden",e.left="0px",e.top="0px",e.textAlign="left"}(this.container.style),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.canvas.appendChild(this.drawersContainer),this.canvas.appendChild(this.overlaysContainer),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new $.MouseTracker({element:this.canvas,startDisabled:this.mouseNavEnabled?!1:!0,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,keyDownHandler:$.delegate(this,onCanvasKeyDown),keyHandler:$.delegate(this,onCanvasKeyPress),clickHandler:$.delegate(this,onCanvasClick),dblClickHandler:$.delegate(this,onCanvasDblClick),dragHandler:$.delegate(this,onCanvasDrag),dragEndHandler:$.delegate(this,onCanvasDragEnd),enterHandler:$.delegate(this,onCanvasEnter),exitHandler:$.delegate(this,onCanvasExit),pressHandler:$.delegate(this,onCanvasPress),releaseHandler:$.delegate(this,onCanvasRelease),nonPrimaryPressHandler:$.delegate(this,onCanvasNonPrimaryPress),nonPrimaryReleaseHandler:$.delegate(this,onCanvasNonPrimaryRelease),scrollHandler:$.delegate(this,onCanvasScroll),pinchHandler:$.delegate(this,onCanvasPinch)}),this.outerTracker=new $.MouseTracker({element:this.container,startDisabled:this.mouseNavEnabled?!1:!0,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:$.delegate(this,onContainerEnter),exitHandler:$.delegate(this,onContainerExit)}),this.toolbar&&(this.toolbar=new $.ControlDock({element:this.toolbar})),this.bindStandardControls(),this.bindSequenceControls(),i&&(this.open(i),this.tileSources.length>1&&this._updateSequenceButtons(this.initialPage));for(r=0;r<this.customControls.length;r++)this.addControl(this.customControls[r].id,{anchor:this.customControls[r].anchor});$.requestAnimationFrame(function(){beginControlsAutoHide(n)})},$.extend($.Viewer.prototype,$.EventSource.prototype,$.ControlDock.prototype,{isOpen:function(){return!!this.source},openDzi:function(e){return this.open(e)},openTileSource:function(e){return this.open(e)},open:function(e){var t=this;return t._hideMessage(),getTileSourceImplementation(t,e,function(e){openTileSource(t,e)},function(e){t.raiseEvent("open-failed",e)}),this},close:function(){return THIS[this.hash]?(this._updateRequestId!==null&&($.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),this.drawersContainer.innerHTML="",this.drawer&&this.drawer.destroy(),this.source=null,this.drawer=null,this.drawers=[],this.viewport=this.preserveViewport?this.viewport:null,VIEWERS[this.hash]=null,delete VIEWERS[this.hash],this.raiseEvent("close"),this):this},destroy:function(){this.close(),this.removeAllHandlers();if(this.element)while(this.element.firstChild)this.element.removeChild(this.element.firstChild);this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),THIS[this.hash]=null,delete THIS[this.hash],this.canvas=null,this.container=null,this.element=null},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(e){return this.innerTracker.setTracking(e),this.raiseEvent("mouse-enabled",{enabled:e}),this},areControlsEnabled:function(){var e=this.controls.length,t;for(t=0;t<this.controls.length;t++)e=e&&this.controls[t].isVisibile();return e},setControlsEnabled:function(e){return e?abortControlsAutoHide(this):beginControlsAutoHide(this),this.raiseEvent("controls-enabled",{enabled:e}),this},isFullPage:function(){return THIS[this.hash].fullPage},setFullPage:function(e){var t=document.body,n=t.style,r=document.documentElement.style,i=this,s,o,u;if(e==this.isFullPage())return this;var a={fullPage:e,preventDefaultAction:!1};this.raiseEvent("pre-full-page",a);if(a.preventDefaultAction)return this;if(e){this.elementSize=$.getElementSize(this.element),this.pageScroll=$.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=n.margin,this.docMargin=r.margin,n.margin="0",r.margin="0",this.bodyPadding=n.padding,this.docPadding=r.padding,n.padding="0",r.padding="0",this.bodyWidth=n.width,this.bodyHeight=n.height,n.width="100%",n.height="100%",this.previousBody=[],THIS[this.hash].prevElementParent=this.element.parentNode,THIS[this.hash].prevNextSibling=this.element.nextSibling,THIS[this.hash].prevElementWidth=this.element.style.width,THIS[this.hash].prevElementHeight=this.element.style.height,o=t.childNodes.length;for(u=0;u<o;u++)this.previousBody.push(t.childNodes[0]),t.removeChild(t.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,t.appendChild(this.toolbar.element),$.addClass(this.toolbar.element,"fullpage")),$.addClass(this.element,"fullpage"),t.appendChild(this.element),this.element.style.height=$.getWindowSize().y+"px",this.element.style.width=$.getWindowSize().x+"px",this.toolbar&&this.toolbar.element&&(this.element.style.height=$.getElementSize(this.element).y-$.getElementSize(this.toolbar.element).y+"px"),THIS[this.hash].fullPage=!0,$.delegate(this,onContainerEnter)({})}else{this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,n.margin=this.bodyMargin,r.margin=this.docMargin,n.padding=this.bodyPadding,r.padding=this.docPadding,n.width=this.bodyWidth,n.height=this.bodyHeight,t.removeChild(this.element),o=this.previousBody.length;for(u=0;u<o;u++)t.appendChild(this.previousBody.shift());$.removeClass(this.element,"fullpage"),THIS[this.hash].prevElementParent.insertBefore(this.element,THIS[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(t.removeChild(this.toolbar.element),$.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=THIS[this.hash].prevElementWidth,this.element.style.height=THIS[this.hash].prevElementHeight;var f=0,l=function(){$.setPageScroll(i.pageScroll);var e=$.getPageScroll();f++,(f<10&&e.x!==i.pageScroll.x||e.y!==i.pageScroll.y)&&$.requestAnimationFrame(l)};$.requestAnimationFrame(l),THIS[this.hash].fullPage=!1,$.delegate(this,onContainerExit)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:e}),this},setFullScreen:function(e){var t=this;if(!$.supportsFullScreen)return this.setFullPage(e);if($.isFullScreen()===e)return this;var n={fullScreen:e,preventDefaultAction:!1};this.raiseEvent("pre-full-screen",n);if(n.preventDefaultAction)return this;if(e){this.setFullPage(!0);if(!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var r=function(){var e=$.isFullScreen();e||($.removeEvent(document,$.fullScreenEventName,r),$.removeEvent(document,$.fullScreenErrorEventName,r),t.setFullPage(!1),t.isFullPage()&&(t.element.style.width=t.fullPageStyleWidth,t.element.style.height=t.fullPageStyleHeight)),t.navigator&&t.viewport&&t.navigator.update(t.viewport),t.raiseEvent("full-screen",{fullScreen:e})};$.addEvent(document,$.fullScreenEventName,r),$.addEvent(document,$.fullScreenErrorEventName,r),$.requestFullScreen(document.body)}else $.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!="hidden"},setVisible:function(e){return this.container.style.visibility=e?"":"hidden",this.raiseEvent("visible",{visible:e}),this},addLayer:function(e){function r(e){t.raiseEvent("add-layer-failed",e)}var t=this,n=e.tileSource;if(!this.isOpen())throw new Error("An image must be loaded before adding layers.");if(!n)throw new Error("No tile source provided as new layer.");if(this.collectionMode)throw new Error("Layers not supported in collection mode.");return getTileSourceImplementation(this,n,function(n){if(n instanceof Array){r({message:"Sequences can not be added as layers.",source:n,options:e});return}for(var i=0;i<t.drawers.length;i++){var s=t.drawers[i].source.aspectRatio,o=s-n.aspectRatio;if(Math.abs(o)>t.layersAspectRatioEpsilon){r({message:"Aspect ratio mismatch with layer "+i+".",source:n,options:e});return}}var u=new $.Drawer({viewer:t,source:n,viewport:t.viewport,element:t.drawersContainer,opacity:e.opacity!==undefined?e.opacity:t.opacity,maxImageCacheCount:t.maxImageCacheCount,imageLoaderLimit:t.imageLoaderLimit,minZoomImageRatio:t.minZoomImageRatio,wrapHorizontal:t.wrapHorizontal,wrapVertical:t.wrapVertical,immediateRender:t.immediateRender,blendTime:t.blendTime,alwaysBlend:t.alwaysBlend,minPixelRatio:t.minPixelRatio,timeout:t.timeout,debugMode:t.debugMode,debugGridColor:t.debugGridColor});t.drawers.push(u),e.level!==undefined&&t.setLayerLevel(u,e.level),THIS[t.hash].forceRedraw=!0,t.raiseEvent("add-layer",{options:e,drawer:u})},function(t){t.options=e,r(t)}),this},getLayerAtLevel:function(e){if(e>=this.drawers.length)throw new Error("Level bigger than number of layers.");return this.drawers[e]},getLevelOfLayer:function(e){return $.indexOf(this.drawers,e)},getLayersCount:function(){return this.drawers.length},setLayerLevel:function(e,t){var n=this.getLevelOfLayer(e);if(t>=this.drawers.length)throw new Error("Level bigger than number of layers.");if(t===n||n===-1)return this;if(t===0||n===0){if(THIS[this.hash].sequenced)throw new Error("Cannot reassign base level when in sequence mode.");this.drawer=t===0?e:this.getLayerAtLevel(t),this.source=this.drawer.source}this.drawers.splice(n,1),this.drawers.splice(t,0,e),this.drawersContainer.removeChild(e.canvas);if(t===0){var r=this.drawers[1].canvas;r.parentNode.insertBefore(e.canvas,r)}else{var i=this.drawers[t-1].canvas;i.parentNode.insertBefore(e.canvas,i.nextSibling)}return this.raiseEvent("layer-level-changed",{drawer:e,previousLevel:n,newLevel:t}),this},removeLayer:function(e){var t=this.drawers.indexOf(e);if(t===-1)return this;if(t===0){if(THIS[this.hash].sequenced)throw new Error("Cannot remove base layer when in sequence mode.");if(this.drawers.length===1)return this.close(),this;this.drawer=this.drawers[1]}return this.drawers.splice(t,1),this.drawersContainer.removeChild(e.canvas),this.raiseEvent("remove-layer",{drawer:e}),this},forceRedraw:function(){return THIS[this.hash].forceRedraw=!0,this},bindSequenceControls:function(){var e=$.delegate(this,onFocus),t=$.delegate(this,onBlur),n=$.delegate(this,onNext),r=$.delegate(this,onPrevious),i=this.navImages,s=!0;if(this.showSequenceControl&&THIS[this.hash].sequenced){if(this.previousButton||this.nextButton)s=!1;this.previousButton=new $.Button({element:this.previousButton?$.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.PreviousPage"),srcRest:resolveUrl(this.prefixUrl,i.previous.REST),srcGroup:resolveUrl(this.prefixUrl,i.previous.GROUP),srcHover:resolveUrl(this.prefixUrl,i.previous.HOVER),srcDown:resolveUrl(this.prefixUrl,i.previous.DOWN),onRelease:r,onFocus:e,onBlur:t}),this.nextButton=new $.Button({element:this.nextButton?$.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.NextPage"),srcRest:resolveUrl(this.prefixUrl,i.next.REST),srcGroup:resolveUrl(this.prefixUrl,i.next.GROUP),srcHover:resolveUrl(this.prefixUrl,i.next.HOVER),srcDown:resolveUrl(this.prefixUrl,i.next.DOWN),onRelease:n,onFocus:e,onBlur:t}),this.navPrevNextWrap||this.previousButton.disable(),s&&(this.paging=new $.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:$.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||$.ControlAnchor.TOP_LEFT}))}return this},bindStandardControls:function(){var e=$.delegate(this,beginZoomingIn),t=$.delegate(this,endZooming),n=$.delegate(this,doSingleZoomIn),r=$.delegate(this,beginZoomingOut),i=$.delegate(this,doSingleZoomOut),s=$.delegate(this,onHome),o=$.delegate(this,onFullScreen),u=$.delegate(this,onRotateLeft),a=$.delegate(this,onRotateRight),f=$.delegate(this,onFocus),l=$.delegate(this,onBlur),c=this.navImages,h=[],p=!0;if(this.showNavigationControl){if(this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton)p=!1;this.showZoomControl&&(h.push(this.zoomInButton=new $.Button({element:this.zoomInButton?$.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomIn"),srcRest:resolveUrl(this.prefixUrl,c.zoomIn.REST),srcGroup:resolveUrl(this.prefixUrl,c.zoomIn.GROUP),srcHover:resolveUrl(this.prefixUrl,c.zoomIn.HOVER),srcDown:resolveUrl(this.prefixUrl,c.zoomIn.DOWN),onPress:e,onRelease:t,onClick:n,onEnter:e,onExit:t,onFocus:f,onBlur:l})),h.push(this.zoomOutButton=new $.Button({element:this.zoomOutButton?$.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomOut"),srcRest:resolveUrl(this.prefixUrl,c.zoomOut.REST),srcGroup:resolveUrl(this.prefixUrl,c.zoomOut.GROUP),srcHover:resolveUrl(this.prefixUrl,c.zoomOut.HOVER),srcDown:resolveUrl(this.prefixUrl,c.zoomOut.DOWN),onPress:r,onRelease:t,onClick:i,onEnter:r,onExit:t,onFocus:f,onBlur:l}))),this.showHomeControl&&h.push(this.homeButton=new $.Button({element:this.homeButton?$.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.Home"),srcRest:resolveUrl(this.prefixUrl,c.home.REST),srcGroup:resolveUrl(this.prefixUrl,c.home.GROUP),srcHover:resolveUrl(this.prefixUrl,c.home.HOVER),srcDown:resolveUrl(this.prefixUrl,c.home.DOWN),onRelease:s,onFocus:f,onBlur:l})),this.showFullPageControl&&h.push(this.fullPageButton=new $.Button({element:this.fullPageButton?$.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.FullPage"),srcRest:resolveUrl(this.prefixUrl,c.fullpage.REST),srcGroup:resolveUrl(this.prefixUrl,c.fullpage.GROUP),srcHover:resolveUrl(this.prefixUrl,c.fullpage.HOVER),srcDown:resolveUrl(this.prefixUrl,c.fullpage.DOWN),onRelease:o,onFocus:f,onBlur:l})),this.showRotationControl&&(h.push(this.rotateLeftButton=new $.Button({element:this.rotateLeftButton?$.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateLeft"),srcRest:resolveUrl(this.prefixUrl,c.rotateleft.REST),srcGroup:resolveUrl(this.prefixUrl,c.rotateleft.GROUP),srcHover:resolveUrl(this.prefixUrl,c.rotateleft.HOVER),srcDown:resolveUrl(this.prefixUrl,c.rotateleft.DOWN),onRelease:u,onFocus:f,onBlur:l})),h.push(this.rotateRightButton=new $.Button({element:this.rotateRightButton?$.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateRight"),srcRest:resolveUrl(this.prefixUrl,c.rotateright.REST),srcGroup:resolveUrl(this.prefixUrl,c.rotateright.GROUP),srcHover:resolveUrl(this.prefixUrl,c.rotateright.HOVER),srcDown:resolveUrl(this.prefixUrl,c.rotateright.DOWN),onRelease:a,onFocus:f,onBlur:l}))),p&&(this.buttons=new $.ButtonGroup({buttons:h,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttons.element,this.addHandler("open",$.delegate(this,lightUp)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:$.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||$.ControlAnchor.TOP_LEFT}))}return this},currentPage:function(){return THIS[this.hash].sequence},goToPage:function(e){return e>=0&&e<this.tileSources.length&&(this.raiseEvent("page",{page:e}),THIS[this.hash].sequence=e,this._updateSequenceButtons(e),this.open(this.tileSources[e]),this.referenceStrip&&this.referenceStrip.setFocus(e)),this},addOverlay:function(e,t,n,r){var i;return $.isPlainObject(e)?i=e:i={element:e,location:t,placement:n,onDraw:r},e=$.getElement(i.element),getOverlayIndex(this.currentOverlays,e)>=0?this:(this.currentOverlays.push(getOverlayObject(this,i)),THIS[this.hash].forceRedraw=!0,this.raiseEvent("add-overlay",{element:e,location:i.location,placement:i.placement}),this)},updateOverlay:function(e,t,n){var r;return e=$.getElement(e),r=getOverlayIndex(this.currentOverlays,e),r>=0&&(this.currentOverlays[r].update(t,n),THIS[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:e,location:t,placement:n})),this},removeOverlay:function(e){var t;return e=$.getElement(e),t=getOverlayIndex(this.currentOverlays,e),t>=0&&(this.currentOverlays[t].destroy(),this.currentOverlays.splice(t,1),THIS[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:e})),this},clearOverlays:function(){while(this.currentOverlays.length>0)this.currentOverlays.pop().destroy();return THIS[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},_updateSequenceButtons:function(e){this.nextButton&&(this.tileSources.length-1===e?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(e>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(e){this._hideMessage();var t=$.makeNeutralElement("div");t.appendChild(document.createTextNode(e)),this.messageDiv=$.makeCenteredNode(t),$.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var e=this.messageDiv;e&&(e.parentNode.removeChild(e),delete this.messageDiv)},gestureSettingsByDeviceType:function(e){switch(e){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}}})})(OpenSeadragon)}.call(root),amdExports})})(this);